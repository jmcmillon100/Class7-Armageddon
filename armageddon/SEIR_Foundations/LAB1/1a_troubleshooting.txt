Set your variables correctly:

REGION="us-east-1"
INSTANCE_ID="i-0123456789abcdef0"
SECRET_ID="my-db-secret"   # name or ARN


1) PASS/FAIL: Secret exists

aws secretsmanager describe-secret \
  --secret-id "$SECRET_ID" \
  --region "$REGION" >/dev/null 2>&1 \
  && echo "PASS: secret exists ($SECRET_ID)" \
  || (echo "FAIL: secret not found or no permission ($SECRET_ID)"; exit 1)

2) PASS/FAIL: EC2 instance has an IAM instance profile attached

aws ec2 describe-instances \
  --instance-ids "$INSTANCE_ID" \
  --region "$REGION" \
  --query "Reservations[0].Instances[0].IamInstanceProfile.Arn" \
  --output text 2>/dev/null \
  | grep -q '^arn:aws:iam::' \
  && echo "PASS: instance has IAM role attached ($INSTANCE_ID)" \
  || (echo "FAIL: no IAM instance profile attached ($INSTANCE_ID)"; exit 1)

3) PASS/FAIL: Extract the instance profile name (for next checks)
(This prints the profile name; exits non-zero if missing.)

PROFILE_NAME="$(aws ec2 describe-instances \
  --instance-ids "$INSTANCE_ID" \
  --region "$REGION" \
  --query "Reservations[0].Instances[0].IamInstanceProfile.Arn" \
  --output text 2>/dev/null | awk -F/ '{print $NF}')"

[ -n "$PROFILE_NAME" ] && [ "$PROFILE_NAME" != "None" ] \
  && echo "PASS: instance profile = $PROFILE_NAME" \
  || (echo "FAIL: could not resolve instance profile"; exit 1)

4) PASS/FAIL: Resolve instance profile → role name

ROLE_NAME="$(aws iam get-instance-profile \
  --instance-profile-name "$PROFILE_NAME" \
  --query "InstanceProfile.Roles[0].RoleName" \
  --output text 2>/dev/null)"

[ -n "$ROLE_NAME" ] && [ "$ROLE_NAME" != "None" ] \
  && echo "PASS: role name = $ROLE_NAME" \
  || (echo "FAIL: could not resolve role from instance profile"; exit 1)

5) PASS/FAIL: Role has some Secrets Manager read capability (rough check)
This is a basic guardrail—useful for labs, not a full audit.

aws iam list-attached-role-policies \
  --role-name "$ROLE_NAME" \
  --query "AttachedPolicies[].PolicyArn" \
  --output text 2>/dev/null \
  | grep -Eq 'SecretsManager|secretsmanager' \
  && echo "PASS: role likely has Secrets Manager-related policy attached ($ROLE_NAME)" \
  || (echo "FAIL: role appears to lack Secrets Manager-related managed policies ($ROLE_NAME)"; exit 1)


6) PASS/FAIL: From inside EC2, prove the instance identity is the expected role
Run on your EC2:

aws sts get-caller-identity \
  --query "Arn" --output text 2>/dev/null \
  | grep -q ":assumed-role/$ROLE_NAME/" \
  && echo "PASS: running as expected role ($ROLE_NAME)" \
  || (echo "FAIL: not running as expected role ($ROLE_NAME)"; exit 1)


7) PASS/FAIL: From inside EC2, role can read the secret metadata (safe)
Run on the EC2:

aws secretsmanager describe-secret \
  --secret-id "$SECRET_ID" \
  --region "$REGION" >/dev/null 2>&1 \
  && echo "PASS: role can describe secret ($SECRET_ID)" \
  || (echo "FAIL: role cannot describe secret ($SECRET_ID)"; exit 1)

8) PASS/FAIL: From inside EC2, role can read the secret value (lab-approved only)
Run on your EC2:

aws secretsmanager get-secret-value \
  --secret-id "$SECRET_ID" \
  --region "$REGION" \
  --query "SecretString" --output text >/dev/null 2>&1 \
  && echo "PASS: role can read secret value ($SECRET_ID)" \
  || (echo "FAIL: role cannot read secret value ($SECRET_ID)"; exit 1)

9) OPTIONAL Guardrail: Fail if secret rotation is disabled

aws secretsmanager describe-secret \
  --secret-id "$SECRET_ID" \
  --region "$REGION" \
  --query "RotationEnabled" \
  --output text 2>/dev/null \
  | grep -qi '^True$' \
  && echo "PASS: rotation enabled ($SECRET_ID)" \
  || (echo "FAIL: rotation disabled or unknown ($SECRET_ID)"; exit 1)

10) OPTIONAL Guardrail: Fail if secret policy allows wildcard principal

aws secretsmanager get-resource-policy \
  --secret-id "$SECRET_ID" \
  --region "$REGION" \
  --query "ResourcePolicy" \
  --output text 2>/dev/null \
  | grep -q '"Principal":"\*"' \
  && (echo "FAIL: secret resource policy allows wildcard principal"; exit 1) \
  || echo "PASS: no wildcard principal detected (basic check)"










